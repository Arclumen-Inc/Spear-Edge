================================================================================
TRIPWIRE-EDGE COMPATIBILITY GUIDE
================================================================================
Document: TRIPWIRE_EDGE_COMPATIBILITY.txt
Purpose: WebSocket connection and event ingest protocol for Tripwire to ensure
         compatibility with SPEAR-Edge

================================================================================
1. OVERVIEW
================================================================================

SPEAR-Edge requires TWO separate connections from Tripwire:
1. WebSocket connection for connection status and control
2. HTTP POST for event ingest (detection events)

Both connections are REQUIRED for proper operation. The WebSocket connection
is the authoritative source for connection status. HTTP events alone do NOT
establish a "connected" status.

Connection Status Logic:
- Edge considers a node "connected" if:
  a. WebSocket connection is established AND
  b. Last heartbeat received within 5 seconds (CONNECTED_SECS = 5.0)
- HTTP events do NOT set connected status (they are advisory only)

================================================================================
2. WEBSOCKET CONNECTION PROTOCOL
================================================================================

2.1 Endpoint

Edge provides TWO WebSocket endpoints (both work identically):
- ws://<edge_ip>/ws/tripwire
- ws://<edge_ip>/ws/tripwire_link

Use either endpoint. Both use the same handler.

2.2 Connection Lifecycle

1. Connect to WebSocket endpoint
2. Send "hello" message within 5 seconds (HELLO_TIMEOUT_S = 5.0)
3. Receive "edge_state" message from Edge
4. Send periodic "heartbeat" messages (every 2-4 seconds recommended)
5. Optionally send "status" messages for status updates

2.3 Hello Message (REQUIRED - First Message)

The FIRST message after WebSocket connection MUST be a "hello" message.
Edge will close the connection if:
- No hello received within 5 seconds
- Hello message is not valid JSON
- Hello message type is not "hello"
- Hello message is missing "node_id"

Hello Message Format (JSON):
{
  "type": "hello",
  "node_id": "tripwire-01",           // REQUIRED: Unique node identifier
  "callsign": "Tripwire-01",         // Optional: Human-readable name (defaults to node_id)
  "gps": {                            // Optional: GPS coordinates
    "gps_lat": 37.7749,
    "gps_lon": -122.4194,
    "gps_alt_ft": 100.0
  },
  "system_time": 1234567890.0,       // Optional: Unix timestamp
  "meta": {                           // Optional: Additional metadata
    "sdr_driver": "soapy_bladerf",
    "sdr": "bladeRF 2.0 micro xA4",
    "version": "1.0.0"
  }
}

Example (minimal required):
{
  "type": "hello",
  "node_id": "tripwire-01"
}

2.4 Edge State Response

After receiving hello, Edge will send an "edge_state" message:

{
  "type": "edge_state",
  "mode": "manual" | "armed" | "tasked"
}

This indicates Edge's current operational mode:
- "manual": Operator control only, no auto-captures
- "armed": Automatic capture enabled (subject to policy)
- "tasked": Internal state during capture (transient)

2.5 Heartbeat Messages (REQUIRED - Periodic)

Tripwire MUST send heartbeat messages to maintain connection status.
Heartbeats must be sent at least every 5 seconds (CONNECTED_SECS = 5.0).

Recommended: Send heartbeat every 2-4 seconds for safety margin.

Heartbeat Message Format (JSON):
{
  "type": "heartbeat"
}

Edge updates:
- node.connected = True
- node.ws_last_seen = current_time
- node.last_seen = current_time

If no heartbeat is received for > 5 seconds, Edge considers the node
disconnected (even if WebSocket is still open).

2.6 Status Messages (Optional)

Tripwire can send status updates via "status" messages:

Status Message Format (JSON):
{
  "type": "status",
  "scan_plan": "fhss_track",         // Current scan plan
  "sdr_status": {...},               // Optional: SDR status
  "gps": {...},                      // Optional: Updated GPS
  // ... any other status fields
}

Edge updates:
- node.ws_last_seen = current_time
- node.last_seen = current_time
- Calls update_ws_status() with status dict

2.7 Scan Plan Commands (Edge → Tripwire)

Edge may send scan plan commands to Tripwire:

{
  "type": "set_scan_plan",
  "scan_plan": "fhss_track"
}

Tripwire should:
- Acknowledge receipt (optional, but recommended)
- Update its scan plan
- Send status message with new scan_plan

2.8 Connection Cleanup

If WebSocket disconnects:
- Edge marks node as disconnected (node.connected = False)
- Edge removes WebSocket from tripwire_links dict
- Node must reconnect and send hello again

If Tripwire reconnects with same node_id:
- Edge closes old WebSocket connection
- New connection replaces old one
- Node must send hello again

2.9 Error Handling

Edge will close WebSocket with code 1008 (Policy Violation) if:
- No hello received within 5 seconds
- Invalid JSON in hello message
- First message is not "hello"
- Missing "node_id" in hello

Tripwire should:
- Reconnect on WebSocket close
- Send hello immediately after reconnect
- Log close code and reason for debugging

2.10 Complete WebSocket Flow Example

Tripwire Side:
1. Connect to ws://edge_ip/ws/tripwire
2. Send: {"type": "hello", "node_id": "tripwire-01", "callsign": "Tripwire-01"}
3. Receive: {"type": "edge_state", "mode": "armed"}
4. Every 2-4 seconds: Send {"type": "heartbeat"}
5. On status change: Send {"type": "status", "scan_plan": "fhss_track"}
6. On disconnect: Reconnect and repeat from step 2

Edge Side:
1. Accept WebSocket connection
2. Wait for hello (timeout 5s)
3. Validate hello (type="hello", node_id present)
4. Register node in tripwire_links dict
5. Mark node as connected
6. Send edge_state message
7. Process heartbeats (update last_seen)
8. Process status messages
9. On disconnect: Mark node disconnected, cleanup

================================================================================
3. EVENT INGEST PROTOCOL (HTTP POST)
================================================================================

3.1 Endpoint

POST http://<edge_ip>/api/tripwire/event

Alternative (legacy, same handler):
POST http://<edge_ip>/api/tripwire/cue

3.2 Event Payload Format

Edge expects events in the following format (per Tripwire v1.1 alignment):

Required Fields:
{
  "schema": "spear.tripwire.event.v1",    // REQUIRED: Schema identifier
  "type": "rf_cue" | "fhss_cluster" | "confirmed_event" | ...,  // REQUIRED: Event type
  "stage": "energy" | "cue" | "confirmed",  // REQUIRED: Detection stage
  "node_id": "tripwire-01",               // REQUIRED: Must match WebSocket node_id
  "freq_hz": 915000000.0,                  // REQUIRED: Frequency in Hz (must be > 0)
  "timestamp": 1234567890.0                // REQUIRED: Unix timestamp
}

Optional Fields (but recommended):
{
  "confidence": 0.95,                      // Signal confidence [0.0, 1.0]
  "classification": "drone_control",       // Classification label
  "scan_plan": "fhss_track",               // Current scan plan
  "bandwidth_hz": 2000000.0,               // Bandwidth in Hz
  "delta_db": 15.5,                        // Signal delta above noise (dB)
  "level_db": -45.0,                       // Absolute signal level (dB)
  "callsign": "Tripwire-01",               // Node callsign
  "confidence_source": "ml_model",          // Source of confidence
  "hypothesis": "FHSS pattern detected",    // Detection hypothesis
  "remarks": "Additional context"           // Free-form remarks
}

3.3 Event Processing

Edge processes events as follows:

1. Event Reception:
   - Event always recorded as cue (advisory) and published to UI
   - Event does NOT update connection status (WebSocket is authoritative)

2. Mode Check:
   - If Edge mode != "armed": Return {"accepted": true, "action": "queued_for_operator"}
   - Event appears in UI for operator review, no capture

3. Policy Evaluation (Armed Mode Only):
   - Hard-block: type="rf_cue" → never actionable (advisory only)
   - Hard-block: type="heartbeat" → never actionable
   - Require: stage="confirmed" (energy/cue stages are advisory only)
   - Require: confidence >= 0.90 (default min_confidence)
   - Ignore: scan_plan in ("survey_wide", "wifi_bt_24g") → awareness-only
   - Cooldown checks: global, per-node, per-frequency
   - Rate limit: max 10 captures per minute

4. Auto-Capture (if policy allows):
   - Capture queued with priority 60 (higher than manual)
   - All event metadata preserved in capture request
   - ATAK message sent: "SPEAR-Edge capturing X.XXX MHz from <node_id> (Tripwire cue) for 5.0s"

3.4 Response Format

Success (Event Accepted):
{
  "accepted": true,
  "action": "queued_for_operator" | "auto_capture_started" | "rejected"
}

If rejected (Armed Mode, Policy Failed):
{
  "accepted": true,
  "action": "rejected",
  "reason": "cue_only" | "stage_not_confirmed_<stage>" | "low_confidence" | 
            "awareness_only" | "global_cooldown" | "node_cooldown" | 
            "freq_cooldown" | "rate_limited" | "queue_full"
}

Error (Invalid Request):
{
  "accepted": false,
  "action": "invalid_freq",
  "reason": "freq_hz missing or invalid"
}

3.5 Event Type Semantics

Per Tripwire v1.1 alignment:
- type="rf_cue": Advisory notification, NEVER triggers auto-capture
- type="heartbeat": System message, NEVER triggers auto-capture
- type="fhss_cluster": FHSS pattern detected
- type="confirmed_event": Confirmed detection (eligible for auto-capture if stage="confirmed")

3.6 Stage Semantics

Per Tripwire v1.1 alignment:
- stage="energy": Energy detection only (advisory, never actionable)
- stage="cue": Cue notification (advisory, never actionable)
- stage="confirmed": Confirmed event (eligible for auto-capture if policy allows)

Only stage="confirmed" events are eligible for auto-capture. All other stages
are advisory only and appear in UI for operator review.

3.7 Complete Event Example

Tripwire sends:
POST http://edge_ip/api/tripwire/event
Content-Type: application/json

{
  "schema": "spear.tripwire.event.v1",
  "type": "confirmed_event",
  "stage": "confirmed",
  "node_id": "tripwire-01",
  "freq_hz": 915000000.0,
  "bandwidth_hz": 2000000.0,
  "confidence": 0.95,
  "classification": "drone_control",
  "scan_plan": "fhss_track",
  "timestamp": 1234567890.0,
  "delta_db": 15.5,
  "level_db": -45.0,
  "callsign": "Tripwire-01",
  "confidence_source": "ml_model",
  "hypothesis": "FHSS pattern with 2.4 GHz characteristics",
  "remarks": "Strong signal, high confidence"
}

Edge responds:
{
  "accepted": true,
  "action": "auto_capture_started"
}

================================================================================
4. CONNECTION STATUS REQUIREMENTS
================================================================================

4.1 Why Edge Shows "Connected" But Tripwire Shows "Not Connected"

Edge considers a node "connected" if:
1. WebSocket connection is established (node.connected = True)
2. AND last_seen is within 5 seconds (CONNECTED_SECS = 5.0)

If Tripwire shows "not connected", likely causes:
- WebSocket not connected (no hello sent, or connection dropped)
- Heartbeats not being sent (must be < 5 seconds apart)
- Heartbeats not being received by Edge (network issue)
- WebSocket connection closed but Tripwire hasn't detected it

4.2 Connection Status Indicators

Edge UI shows connection status based on:
- WebSocket connection: node.connected = True/False
- Last heartbeat: node.ws_last_seen timestamp
- Time since last heartbeat: (now - ws_last_seen) < 5.0 seconds

Tripwire should:
- Monitor WebSocket connection state
- Detect disconnects immediately
- Reconnect and send hello on disconnect
- Send heartbeats every 2-4 seconds
- Log connection state changes

4.3 Troubleshooting Connection Status

If Edge shows connected but Tripwire shows not connected:

1. Check WebSocket connection:
   - Is WebSocket actually connected? (check connection state)
   - Was hello message sent and acknowledged?
   - Is Edge sending edge_state message?

2. Check heartbeats:
   - Are heartbeats being sent every 2-4 seconds?
   - Are heartbeats being received by Edge? (check Edge logs)
   - Is network latency causing delays?

3. Check Edge logs:
   - Look for "[TRIPWIRE-WS]" messages
   - Check for "Registered node" message (confirms hello received)
   - Check for "Client disconnected" message (indicates disconnect)

4. Verify node_id:
   - WebSocket hello must use same node_id as HTTP events
   - Mismatched node_id causes separate registrations

4.4 Connection Status Best Practices

Tripwire should:
- Maintain persistent WebSocket connection
- Send hello immediately after connect
- Send heartbeats every 2-4 seconds (safety margin)
- Detect WebSocket close events
- Reconnect immediately on disconnect
- Log all connection state changes
- Use same node_id for WebSocket and HTTP events

Edge will:
- Accept WebSocket connections
- Require hello within 5 seconds
- Update connection status on each heartbeat
- Mark disconnected if no heartbeat for > 5 seconds
- Clean up on WebSocket close

================================================================================
5. COMPLETE INTEGRATION CHECKLIST
================================================================================

For Tripwire to be fully compatible with Edge:

[ ] WebSocket Connection:
    [ ] Connect to ws://edge_ip/ws/tripwire (or /ws/tripwire_link)
    [ ] Send hello message within 5 seconds of connect
    [ ] Hello includes "type": "hello" and "node_id" (required)
    [ ] Hello optionally includes callsign, gps, meta
    [ ] Receive and handle edge_state message from Edge
    [ ] Send heartbeat every 2-4 seconds
    [ ] Handle set_scan_plan commands from Edge
    [ ] Detect WebSocket disconnects and reconnect

[ ] Event Ingest:
    [ ] Send events to POST http://edge_ip/api/tripwire/event
    [ ] Events include required fields: schema, type, stage, node_id, freq_hz, timestamp
    [ ] node_id matches WebSocket hello node_id
    [ ] Events include optional fields: confidence, classification, scan_plan, bandwidth_hz
    [ ] Handle response: accepted, action, reason

[ ] Connection Status:
    [ ] Monitor WebSocket connection state
    [ ] Show "connected" only when WebSocket is open AND heartbeats are being sent
    [ ] Show "not connected" when WebSocket is closed or no recent heartbeat
    [ ] Reconnect on disconnect
    [ ] Log connection state changes

[ ] Error Handling:
    [ ] Handle WebSocket close codes (especially 1008 for policy violations)
    [ ] Handle HTTP errors (network, timeout, server error)
    [ ] Retry failed connections
    [ ] Log errors for debugging

================================================================================
6. MESSAGE REFERENCE
================================================================================

6.1 Tripwire → Edge (WebSocket)

Hello (REQUIRED - First Message):
{
  "type": "hello",
  "node_id": "tripwire-01",
  "callsign": "Tripwire-01",  // optional
  "gps": {...},                // optional
  "system_time": 1234567890.0, // optional
  "meta": {...}                // optional
}

Heartbeat (REQUIRED - Periodic):
{
  "type": "heartbeat"
}

Status (Optional):
{
  "type": "status",
  "scan_plan": "fhss_track",
  // ... other status fields
}

6.2 Edge → Tripwire (WebSocket)

Edge State (Sent after hello):
{
  "type": "edge_state",
  "mode": "manual" | "armed" | "tasked"
}

Scan Plan Command:
{
  "type": "set_scan_plan",
  "scan_plan": "fhss_track"
}

6.3 Tripwire → Edge (HTTP POST)

Event:
{
  "schema": "spear.tripwire.event.v1",
  "type": "confirmed_event",
  "stage": "confirmed",
  "node_id": "tripwire-01",
  "freq_hz": 915000000.0,
  "timestamp": 1234567890.0,
  "confidence": 0.95,
  "classification": "drone_control",
  "scan_plan": "fhss_track",
  "bandwidth_hz": 2000000.0,
  "delta_db": 15.5,
  "level_db": -45.0,
  "callsign": "Tripwire-01",
  "confidence_source": "ml_model",
  "hypothesis": "...",
  "remarks": "..."
}

6.4 Edge → Tripwire (HTTP Response)

Success:
{
  "accepted": true,
  "action": "auto_capture_started" | "queued_for_operator" | "rejected"
}

Rejected (with reason):
{
  "accepted": true,
  "action": "rejected",
  "reason": "cue_only" | "stage_not_confirmed_<stage>" | "low_confidence" | ...
}

Error:
{
  "accepted": false,
  "action": "invalid_freq",
  "reason": "freq_hz missing or invalid"
}

================================================================================
7. TROUBLESHOOTING
================================================================================

7.1 Edge Shows Connected, Tripwire Shows Not Connected

Symptoms:
- Edge UI shows node as connected (green LED)
- Tripwire shows not connected

Diagnosis:
- Check if WebSocket is actually connected (connection state)
- Check if heartbeats are being sent (every 2-4 seconds)
- Check Edge logs for "[TRIPWIRE-WS]" messages
- Verify node_id matches between WebSocket and HTTP

Solution:
- Ensure WebSocket connection is maintained
- Send heartbeats every 2-4 seconds
- Monitor WebSocket connection state in Tripwire
- Reconnect if WebSocket is closed

7.2 WebSocket Connection Closes Immediately

Symptoms:
- WebSocket connects then closes with code 1008

Diagnosis:
- Check if hello message was sent within 5 seconds
- Check if hello message is valid JSON
- Check if hello message has type="hello"
- Check if hello message has node_id field

Solution:
- Send hello immediately after WebSocket connect
- Ensure hello message format is correct
- Include required node_id field

7.3 Events Not Triggering Captures

Symptoms:
- Events sent but no captures triggered

Diagnosis:
- Check Edge mode (must be "armed" for auto-capture)
- Check event stage (must be "confirmed")
- Check event type (must not be "rf_cue" or "heartbeat")
- Check confidence (must be >= 0.90)
- Check cooldown status
- Check Edge logs for rejection reasons

Solution:
- Set Edge to "armed" mode
- Send events with stage="confirmed"
- Ensure confidence >= 0.90
- Wait for cooldown periods
- Check rejection reason in response

7.4 Connection Status Inconsistent

Symptoms:
- Connection status changes unexpectedly

Diagnosis:
- Check heartbeat frequency (must be < 5 seconds)
- Check network latency
- Check for WebSocket disconnects
- Check Edge logs for connection events

Solution:
- Send heartbeats every 2-4 seconds (safety margin)
- Monitor WebSocket connection state
- Reconnect immediately on disconnect
- Check network stability

================================================================================
8. TESTING CHECKLIST
================================================================================

Test WebSocket Connection:
[ ] Connect to ws://edge_ip/ws/tripwire
[ ] Send hello within 5 seconds
[ ] Receive edge_state message
[ ] Send heartbeat every 2-4 seconds
[ ] Verify Edge shows node as connected
[ ] Disconnect and reconnect
[ ] Verify reconnection works

Test Event Ingest:
[ ] Send event with required fields
[ ] Verify response indicates accepted
[ ] Send event with stage="confirmed" and confidence >= 0.90
[ ] Verify capture is triggered (if Edge is armed)
[ ] Send event with stage="cue"
[ ] Verify event appears in UI but no capture
[ ] Test rejection reasons (low confidence, cooldown, etc.)

Test Connection Status:
[ ] Verify Tripwire shows connected when WebSocket is open
[ ] Verify Tripwire shows not connected when WebSocket is closed
[ ] Stop sending heartbeats for > 5 seconds
[ ] Verify Edge marks node as disconnected
[ ] Resume heartbeats
[ ] Verify Edge marks node as connected again

Test Error Handling:
[ ] Send invalid hello (missing node_id)
[ ] Verify WebSocket closes with code 1008
[ ] Send event with invalid freq_hz
[ ] Verify error response
[ ] Disconnect WebSocket during operation
[ ] Verify cleanup and reconnection

================================================================================
END OF DOCUMENT
================================================================================

