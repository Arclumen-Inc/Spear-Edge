SPEAR-Edge Changelog
====================
Starting from: WebGL Rollback (2024-12-XX)

All changes from this point forward will be documented here.

---

ROLLBACK: WebGL Waterfall Implementation
Date: 2024-12-XX
Reason: WebGL not working/viable on Jetson hardware

Changes Rolled Back:
- Removed WebGL2/WebGL1 waterfall rendering attempt
- Removed separate WebGL canvas (#wf_gl) from HTML
- Restored Canvas 2D waterfall as primary rendering method
- Removed all WebGL-related variables, functions, and initialization code
- Simplified waterfall rendering to use only Canvas 2D on main canvas

Files Modified:
- spear_edge/ui/web/index.html
  * Removed <canvas id="wf_gl"> element
  * Restored single <canvas id="spec"> for both FFT and waterfall

- spear_edge/ui/web/styles.css
  * Removed #wf_gl styles (position, z-index, etc.)
  * Simplified #spec to be a single canvas without absolute positioning

- spear_edge/ui/web/app.js
  * Removed WebGL variables: wfCanvas, gl, wfglAttempted, wfglDisabled
  * Removed WebGL state: wfProgram, wfScroll, fftTex, wfQuadBuffer
  * Removed WebGL functions: createWaterfallProgram(), initWebGLIfReady(), initWebGLWaterfall()
  * Removed WebGL canvas resizing from resizeCanvas()
  * Removed WebGL initialization from init()
  * Simplified drawSpectrum() to use Canvas 2D waterfall as primary (removed WebGL conditional)
  * Simplified canvas clearing (removed WebGL-specific clearing logic)

Technical Details:
- Waterfall now renders entirely on the main Canvas 2D context
- Uses device-pixel correct scrolling via drawImage()
- Percentile-based contrast adjustment (20th/95th percentile)
- Smoothed noise floor for visual stability
- Gamma correction for color mapping
- Fade effect for temporal smoothing

---

WATERFALL & FFT FIXES
Date: 2024-12-XX
Status: FFT and waterfall are now good and functioning correctly

Changes Made:
- Fixed waterfall rendering with proper device-pixel coordinate handling
- Added transform isolation (save/restore with identity transform)
- Added comprehensive bounds checking and data validation
- Fixed array index calculations with proper Math.min() guards
- Added Number.isFinite() validation for all dB values
- Fixed color calculations with Math.floor() for integer pixels
- Added range safety checks to prevent division by zero
- Improved error handling to skip invalid data gracefully

Technical Details:
- Waterfall uses device-space coordinates exclusively (no CSS-space mixing)
- Transform is reset to identity before all waterfall operations
- Proper bounds checking prevents array index errors
- Data validation ensures only valid numbers are processed
- Color values are properly floored to integers
- Waterfall scrolls correctly using drawImage() with device pixels
- FFT rendering works correctly with proper coordinate system separation

Result:
- FFT displays correctly with proper scaling and visualization
- Waterfall renders and scrolls smoothly without artifacts
- No coordinate system conflicts between FFT and waterfall
- Robust error handling prevents crashes from invalid data
- Both FFT and waterfall are functioning correctly and ready for use

---

MEMORY-EFFICIENT CAPTURE PIPELINE
Date: 2025-01-05
Status: Fixed OOM crashes during large captures

Problem:
- Captures at 10 MS/s for 5 seconds (50M samples) were causing OOM kills
- Full-resolution spectrograms (~800 MB) were computed in memory
- Total memory usage exceeded 1.4 GB, causing process termination

Solution:
- Implemented streaming IQ capture directly to disk
- Added chunked spectrogram computation (processes 5M samples at a time)
- Generate thumbnails from downsampled spectrogram (512x512) instead of full resolution
- Added aggressive memory cleanup with garbage collection

Changes Made:
- spear_edge/core/capture/capture_manager.py:
  * Added `_capture_iq_to_disk()` for streaming capture (no in-memory buffer)
  * Modified `_execute()` to use chunked spectrogram processing
  * Added `_write_artifacts_from_disk()` for memory-efficient artifact writing
  * Added `_iq_stats_from_file()` for memory-efficient stats computation

- spear_edge/core/capture/spectrogram.py:
  * Added `compute_spectrogram_chunked()` for memory-efficient processing
  * Processes IQ file in 5M sample chunks (~40 MB per chunk)
  * Downsamples frequency axis immediately, then accumulates time axis
  * Final downsampling to 512x512 for ML-ready output

Memory Usage:
- Before: ~1.4 GB (IQ: 400 MB, full spectrogram: 800 MB, intermediates: 200 MB)
- After: ~100-200 MB peak (chunked processing, no full arrays in memory)

Result:
- Captures complete successfully without OOM kills
- Memory usage stays within reasonable limits
- All artifacts still generated correctly
- Supports high sample rates (10-30 MS/s) with long durations

---

CAPTURE QUALITY METRICS
Date: 2025-01-05
Status: Added comprehensive quality assessment

Changes Made:
- spear_edge/core/capture/capture_manager.py:
  * Extended `_iq_stats()` to include DC offsets and clipping detection
  * Added `_derive_quality()` to compute quality flags and warnings
  * Added `_iq_stats_from_file()` for memory-efficient stats from disk
  * Injected quality metrics into capture.json (both in-memory and disk paths)

Quality Metrics:
- DC offsets (I and Q components)
- Clipping detection (fraction of samples within 0.5 dB of max)
- SNR (signal-to-noise ratio)
- Duty cycle (time occupancy)
- Partial capture detection
- Quality status: "ok" or "degraded"
- Warnings array: ["partial_capture", "low_snr", "clipping", "dc_offset"]

capture.json now includes:
```json
"quality": {
  "valid": true,
  "status": "ok",
  "warnings": [],
  "dc_i": 0.0,
  "dc_q": 0.0,
  "rms": 0.123,
  "crest_factor": 2.45,
  "clip_fraction": 0.0,
  "snr_db": 15.3
}
```

---

SPECTROGRAM NORMALIZATION & AUTO-SCALING
Date: 2025-01-05
Status: Improved spectrogram consistency and thumbnail quality

Changes Made:
- spear_edge/core/capture/spectrogram.py:
  * Updated `compute_spectrogram()` to normalize by window energy
  * Changed from magnitude (20*log10) to power (10*log10) conversion
  * Added auto-scaling to `save_spectrogram_thumbnail()` to prevent "all black" images
  * Updated `extract_basic_stats()` to compute duty_cycle correctly (time-based occupancy)

Technical Details:
- Window energy normalization ensures consistent scaling across FFT sizes/windows
- Power-based dB conversion (10*log10) is correct for power spectral density
- Auto-scaling uses 5th/99th percentiles for robust contrast adjustment
- Duty cycle now correctly measures time occupancy (fraction of time bins with signal)
- Activity margin: 6 dB above noise floor (configurable, default 6.0 dB)

Benefits:
- Consistent spectrogram values across different configurations
- Meaningful stats (noise_floor_db, peak_db, snr_db) are now comparable
- Better thumbnails with visible contrast even for weak signals
- Correct duty cycle measurement (time-based, not pixel-based)

---

UI IMPROVEMENTS
Date: 2025-01-05
Status: Fixed capture banner visibility issues

Changes Made:
- spear_edge/ui/web/app.js:
  * Enhanced capture_complete event handler with immediate banner hiding
  * Added fallback timeout when progress reaches 100%
  * Added status polling fallback to detect stale banners
  * Improved CSS class management (remove "active", add "hidden")
  * Added inline style override for immediate visual feedback

Result:
- Capture banner now hides reliably after capture completes
- Multiple fallback mechanisms ensure banner doesn't get stuck
- Better user experience with immediate visual feedback

---

SIGNAL TRIAGE COMPUTATION
Date: 2025-01-05
Status: Added lightweight signal classification from ML spectrogram

Changes Made:
- spear_edge/core/capture/capture_manager.py:
  * Added `_compute_triage()` method to analyze ML spectrogram (512x512)
  * Computes signal presence, burstiness, bandwidth class, and occupied bandwidth
  * Integrated triage into capture.json output

Triage Metrics:
- `signal_present`: Boolean indicating if signal detected (SNR >= 3 dB)
- `bursty`: Boolean indicating if signal is active < 30% of time
- `wideband`: Boolean indicating if > 5% of spectrum is occupied
- `occupied_bw_hz`: Estimated occupied bandwidth in Hz
- `likely_noise`: Boolean indicating if signal is likely just noise (SNR < 3 dB)

capture.json now includes:
```json
"triage": {
  "signal_present": true,
  "bursty": false,
  "wideband": true,
  "occupied_bw_hz": 500000.0,
  "likely_noise": false
}
```

Technical Details:
- Uses ML spectrogram (512x512, noise-floor normalized)
- Activity threshold: 6 dB above noise floor
- Time occupancy: fraction of time bins with any frequency bin above threshold
- Frequency occupancy: fraction of frequency bins with any time bin above threshold
- Bursty detection: duty cycle < 30%
- Wideband detection: occupied fraction > 5%

Benefits:
- Lightweight classification without ML model inference
- Useful for signal triage and filtering before expensive ML processing
- Helps identify signal characteristics (bursty vs continuous, narrowband vs wideband)
- Can be used to filter out noise-only captures

---

ARMED CAPTURE MODE FIXES
Date: 2025-01-05
Status: Fixed missing method and improved armed capture flow

Changes Made:
- spear_edge/core/capture/capture_manager.py:
  * Added `queue_full()` method to check capture queue status
  * Updated comments to clarify bandwidth/gain source (SDR controls vs Tripwire metadata)
  * Improved logging to indicate source of bandwidth/gain settings

Issue Fixed:
- `can_auto_capture()` was calling `capture_mgr.queue_full()` which didn't exist
- This would cause AttributeError when checking queue status during policy evaluation

Result:
- Armed capture mode now works correctly
- Queue status checking works for policy evaluation
- Better logging distinguishes between manual and armed capture settings
- Armed captures use same memory-efficient pipeline as manual captures

---

TRIPWIRE SCAN PLAN DROPDOWN FIX
Date: 2025-01-XX
Status: Fixed incorrect scan plan options in Tripwire node cards

Issue:
- Tripwire node cards in the right panel had incorrect scan plan options
- Dropdown included non-existent plans: "fhss_survey", "fhss_track"
- Missing valid Tripwire scan plans from reference file

Changes Made:
- spear_edge/ui/web/app.js:
  * Updated scan plan dropdown to match Tripwire's actual scan plans
  * Replaced incorrect options with all valid plans from scan_profilesTripwire.py:
    - survey_wide (RF Survey Wide)
    - fhss_subghz (FHSS Control Sub-GHz)
    - fhss_subghz_ibw (FHSS Control IBW Sub-GHz)
    - fhss_eu_868_ibw (FHSS Control IBW EU 868)
    - fhss_eu_433_ibw (FHSS Control IBW EU 433)
    - fhss_24g (FHSS Control 2.4 GHz)
    - digital_vtx_5g8 (Digital VTX 5.8 GHz)
    - analog_vtx_5g8 (Analog FPV VTX 5.8 GHz)
    - voice_narrowband (Voice / PTT Narrowband)
    - wifi_bt_24g (Wi-Fi / Bluetooth 2.4 GHz)
    - manual (Manual Start/Stop MHz)

Result:
- Scan plan dropdown now matches Tripwire's actual scan plan IDs
- Users can select and send correct scan plans to Tripwire nodes
- Prevents errors from sending invalid scan plan names

---

